#!/bin/bash
# 关节限位问题 - 快速修复向导

clear
echo "========================================================================="
echo "🔧 关节锁死问题快速修复向导"
echo "========================================================================="
echo ""
echo "问题现象:"
echo "  ❌ 机械臂在程序运行时出现锁死"
echo "  ❌ MoveIt2规划失败或中途停止"
echo "  ✅ 但手动掉电操作每个关节都正常"
echo ""
echo "根本原因:"
echo "  ⚠️  MoveIt2速度缩放因子过低（默认仅10%）"
echo "  ⚠️  碰撞检测可能过于敏感"
echo "  ⚠️  关节限位可能与实际硬件不匹配"
echo ""
echo "========================================================================="
echo "请选择操作:"
echo "========================================================================="
echo ""
echo "  1️⃣  [推荐] 自动修复配置（提高速度缩放因子）"
echo "  2️⃣  诊断当前关节状态（检测是否接近限位）"
echo "  3️⃣  查看详细文档（JOINT_LIMIT_FIX.md）"
echo "  4️⃣  手动测试关节极限（记录实际限位）"
echo "  5️⃣  退出"
echo ""
read -p "请输入选项 [1-5]: " choice

case $choice in
    1)
        echo ""
        echo "========================================================================="
        echo "🔧 启动自动修复工具..."
        echo "========================================================================="
        ./fix_joint_limits.sh
        ;;
    2)
        echo ""
        echo "========================================================================="
        echo "🔍 启动关节诊断工具..."
        echo "========================================================================="
        echo "💡 手动移动关节可实时查看限位状态"
        echo ""
        python3 diagnose_joint_limits.py
        ;;
    3)
        echo ""
        echo "========================================================================="
        echo "📚 打开详细文档..."
        echo "========================================================================="
        if [ -f "JOINT_LIMIT_FIX.md" ]; then
            cat JOINT_LIMIT_FIX.md | less
        else
            echo "❌ 文件不存在: JOINT_LIMIT_FIX.md"
        fi
        ;;
    4)
        echo ""
        echo "========================================================================="
        echo "🧪 手动测试关节极限"
        echo "========================================================================="
        echo ""
        echo "操作步骤:"
        echo "  1. 启动状态读取工具"
        echo "  2. 手动移动每个关节到极限位置"
        echo "  3. 记录实际最大/最小角度"
        echo "  4. 更新 config/piper_description.xacro 中的限位"
        echo ""
        echo "启动状态读取工具? [y/N]"
        read -p "" start_test
        if [[ "$start_test" =~ ^[Yy]$ ]]; then
            python3 demo/demo_01_read_status_ros2.py
        fi
        ;;
    5)
        echo ""
        echo "退出向导"
        exit 0
        ;;
    *)
        echo ""
        echo "❌ 无效选项"
        exit 1
        ;;
esac
