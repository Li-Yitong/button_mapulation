# æŒ‰é’®åŠ¨ä½œå¹³æ»‘åŒ–ä¿®å¤

## é—®é¢˜æè¿°

### 1ï¸âƒ£ Plugin/Push/Knob æ’å…¥åŠ¨ä½œè¿‡äºæ¿€è¿›
**ç—‡çŠ¶**ï¼š
- æ²¿å¤¹çˆªZè½´å‘å‰æ¨æ—¶ï¼ŒçŒ›åœ°å‘å‰å†²
- åŠ¨ä½œä¸å¤Ÿå¹³æ»‘ï¼Œçœ‹èµ·æ¥å¾ˆçªå…€
- å¯èƒ½å¯¹ç¡¬ä»¶é€ æˆå†²å‡»

**åŸå› **ï¼š
- SDKç›´æ¥å‘é€å…³èŠ‚å‘½ä»¤ï¼Œæ²¡æœ‰é€Ÿåº¦é™åˆ¶
- æ²¡æœ‰åŠ å‡é€Ÿæ§åˆ¶ï¼Œå¯åŠ¨å’Œåœæ­¢éƒ½å¾ˆçªç„¶
- å›ºå®š80Hzé¢‘ç‡ï¼Œé€Ÿåº¦è¿‡å¿«

### 2ï¸âƒ£ Knob æ—‹é’®æ—‹è½¬æ—¶åªæœ‰å¤¹çˆªè½¬åŠ¨
**ç—‡çŠ¶**ï¼š
```python
joints_rotate = actual_joints_step5.copy()
joints_rotate[5] += rotation_angle  # âŒ åªæ”¹å˜joint6
```
- åªæœ‰joint6ï¼ˆå¤¹çˆªæ—‹è½¬è½´ï¼‰åœ¨åŠ¨
- å…¶ä»–5ä¸ªå…³èŠ‚å®Œå…¨é™æ­¢
- ä¸å¤Ÿè‡ªç„¶ï¼Œæœºæ¢°æ„Ÿå¼º

**åŸå› **ï¼š
- ç›´æ¥ä¿®æ”¹joint6è§’åº¦ï¼Œæ²¡æœ‰è€ƒè™‘æ•´ä½“åè°ƒ
- æ²¡æœ‰ä½¿ç”¨ç¬›å¡å°”è·¯å¾„è§„åˆ’
- æœ«ç«¯ä½ç½®å¯èƒ½å› IKè¯¯å·®è€Œåç§»

---

## ä¿®å¤æ–¹æ¡ˆ

### âœ… ä¿®å¤1: æ’å…¥åŠ¨ä½œå¹³æ»‘åŒ–ï¼ˆè¡Œ1520-1548ï¼‰

**æ”¹è¿›ç‚¹**ï¼š
1. **é€Ÿåº¦é™åˆ¶**ï¼š`smooth_speed = min(speed, 20)` - æœ€å¤§é€Ÿåº¦20
2. **åŠ é€Ÿé˜¶æ®µ**ï¼šå‰25%çš„ç‚¹é€æ¸åŠ é€Ÿ
3. **å‡é€Ÿé˜¶æ®µ**ï¼šå25%çš„ç‚¹é€æ¸å‡é€Ÿ
4. **åŠ¨æ€å»¶æ—¶**ï¼šæ ¹æ®é˜¶æ®µè°ƒæ•´å‘é€é¢‘ç‡

**ä¿®å¤åä»£ç **ï¼š
```python
# æ‰§è¡Œç¬›å¡å°”è½¨è¿¹
print(f"  [SDK] æ‰§è¡Œç¬›å¡å°”è½¨è¿¹ ({len(cartesian_traj)}ä¸ªç‚¹)...")

# ğŸ”§ é™ä½é€Ÿåº¦ä½¿åŠ¨ä½œæ›´å¹³æ»‘ï¼ˆåŸspeedå¤ªå¿«ä¼šå¯¼è‡´æ¿€è¿›å†²åˆºï¼‰
smooth_speed = min(speed, 20)  # é™åˆ¶æœ€å¤§é€Ÿåº¦ä¸º20
piper.MotionCtrl_2(0x01, 0x01, smooth_speed, 0x00)

# ğŸ”§ æ·»åŠ åŠ é€Ÿ/å‡é€Ÿé˜¶æ®µ
total_points = len(cartesian_traj)
accel_points = min(5, total_points // 4)  # å‰25%åŠ é€Ÿ
decel_points = min(5, total_points // 4)  # å25%å‡é€Ÿ

for idx, (joints, t) in enumerate(cartesian_traj):
    joints_int = [int(joints[i] * factor) for i in range(6)]
    joints_int[4] = max(-70000, joints_int[4])
    piper.JointCtrl(*joints_int)
    
    # ğŸ”§ åŠ¨æ€è°ƒæ•´å»¶æ—¶å®ç°åŠ å‡é€Ÿ
    if idx < accel_points:
        # åŠ é€Ÿé˜¶æ®µï¼šå»¶æ—¶é€’å‡
        delay = 0.02 * (accel_points - idx) / accel_points + 0.0125
    elif idx >= total_points - decel_points:
        # å‡é€Ÿé˜¶æ®µï¼šå»¶æ—¶é€’å¢
        remaining = total_points - idx
        delay = 0.02 * (decel_points - remaining + 1) / decel_points + 0.0125
    else:
        # åŒ€é€Ÿé˜¶æ®µï¼šå›ºå®šå»¶æ—¶ï¼ˆ80Hzï¼‰
        delay = 0.0125
    
    time.sleep(delay)
```

**æ•ˆæœ**ï¼š
- âœ… å¯åŠ¨å¹³æ»‘ï¼šä¸å†çŒ›å†²
- âœ… åœæ­¢å¹³æ»‘ï¼šä¸å†æ€¥åˆ¹
- âœ… æ•´ä½“åè°ƒï¼šæ‰€æœ‰å…³èŠ‚åŒæ­¥è¿åŠ¨

---

### âœ… ä¿®å¤2: Knobæ—‹è½¬ä½¿ç”¨ç¬›å¡å°”è·¯å¾„ï¼ˆè¡Œ2028-2098ï¼‰

**æ”¹è¿›ç‚¹**ï¼š
1. **ç”Ÿæˆæ—‹è½¬waypoints**ï¼šæ¯5åº¦ä¸€ä¸ªå§¿æ€ç‚¹
2. **ä½ç½®é”å®š**ï¼šä¿æŒXYZåæ ‡ä¸å˜
3. **å§¿æ€æ—‹è½¬**ï¼šç»•æœ«ç«¯Zè½´æ—‹è½¬
4. **å…¨å…³èŠ‚ååŒ**ï¼šæ‰€æœ‰6ä¸ªå…³èŠ‚å‚ä¸è¿åŠ¨

**ä¿®å¤åä»£ç **ï¼š
```python
# æ­¥éª¤5: æ—‹è½¬æ—‹é’®ï¼ˆä¿æŒä½ç½®ä¸å˜ï¼Œåªæ”¹å˜å§¿æ€ï¼‰
# ã€é‡è¦ä¿®å¤ã€‘ä½¿ç”¨ç¬›å¡å°”æ—‹è½¬è·¯å¾„ï¼Œè®©æ‰€æœ‰å…³èŠ‚ååŒå·¥ä½œ
direction_sign = 1 if KNOB_ROTATION_DIRECTION == 'cw' else -1
print(f"\næ­¥éª¤5: æ—‹è½¬ {KNOB_ROTATION_ANGLE}Â° ({KNOB_ROTATION_DIRECTION})...")
actual_joints_step5 = get_current_joints()
actual_T_step5 = piper_arm.forward_kinematics(actual_joints_step5)
actual_xyz_step5 = actual_T_step5[:3, 3]
print(f"  å½“å‰ä½ç½®: XYZ=({actual_xyz_step5[0]:.3f}, {actual_xyz_step5[1]:.3f}, {actual_xyz_step5[2]:.3f})")
print(f"  ä¿æŒä½ç½®ä¸å˜ï¼Œä»…æ—‹è½¬å§¿æ€ {KNOB_ROTATION_ANGLE}Â°")

# ğŸ”§ æ–°æ–¹æ³•ï¼šç”Ÿæˆç¬›å¡å°”æ—‹è½¬è·¯å¾„ï¼ˆä½ç½®ä¸å˜ï¼Œå§¿æ€æ—‹è½¬ï¼‰
rotation_angle_rad = direction_sign * KNOB_ROTATION_ANGLE * PI / 180

# ç”Ÿæˆæ—‹è½¬waypoints
num_rotation_steps = max(10, int(abs(KNOB_ROTATION_ANGLE) / 5))  # æ¯5åº¦ä¸€ä¸ªç‚¹
waypoint_poses_rotation = []

for i in range(1, num_rotation_steps + 1):
    alpha = i / num_rotation_steps
    intermediate_angle = rotation_angle_rad * alpha
    
    # åˆ›å»ºæ—‹è½¬çŸ©é˜µï¼ˆç»•Zè½´æ—‹è½¬ï¼‰
    cos_a = np.cos(intermediate_angle)
    sin_a = np.sin(intermediate_angle)
    rotation_z = np.array([
        [cos_a, -sin_a, 0],
        [sin_a,  cos_a, 0],
        [0,      0,     1]
    ])
    
    # åº”ç”¨æ—‹è½¬åˆ°å½“å‰å§¿æ€
    intermediate_T = actual_T_step5.copy()
    intermediate_T[:3, :3] = actual_T_step5[:3, :3] @ rotation_z  # åœ¨æœ«ç«¯åæ ‡ç³»æ—‹è½¬
    intermediate_T[:3, 3] = actual_xyz_step5  # ä¿æŒä½ç½®ä¸å˜
    
    waypoint_poses_rotation.append(intermediate_T)

# ä½¿ç”¨è‡ªå®šä¹‰ç¬›å¡å°”è§„åˆ’å™¨
print(f"  [ç¬›å¡å°”æ—‹è½¬] ç”Ÿæˆæ—‹è½¬è·¯å¾„ ({num_rotation_steps}ä¸ªwaypoints)...")
cartesian_traj_rotation, fraction_rotation = compute_custom_cartesian_path(
    actual_joints_step5,
    waypoint_poses_rotation,
    eef_step=0.01
)

if fraction_rotation < 0.8 or len(cartesian_traj_rotation) < 2:
    print(f"  âš ï¸  ç¬›å¡å°”æ—‹è½¬è§„åˆ’è¦†ç›–ç‡è¾ƒä½: {fraction_rotation*100:.1f}%")
    print(f"  å›é€€åˆ°ç®€å•joint6æ—‹è½¬...")
    # å›é€€æ–¹æ¡ˆ
    joints_rotate = actual_joints_step5.copy()
    joints_rotate[5] += rotation_angle_rad
    if not control_arm(joints_rotate, KNOB_ROTATION_SPEED, USE_MOVEIT, KNOB_GRIPPER_HOLD):
        return False
else:
    print(f"  âœ“ ç¬›å¡å°”æ—‹è½¬è§„åˆ’æˆåŠŸ (è¦†ç›–ç‡: {fraction_rotation*100:.1f}%, è½¨è¿¹ç‚¹: {len(cartesian_traj_rotation)})")
    
    # æ‰§è¡Œæ—‹è½¬è½¨è¿¹
    print(f"  [SDK] æ‰§è¡Œæ—‹è½¬è½¨è¿¹ ({len(cartesian_traj_rotation)}ä¸ªç‚¹)...")
    smooth_rotation_speed = min(KNOB_ROTATION_SPEED, 15)
    piper.MotionCtrl_2(0x01, 0x01, smooth_rotation_speed, 0x00)
    
    for idx, (joints, t) in enumerate(cartesian_traj_rotation):
        joints_int = [int(joints[i] * factor) for i in range(6)]
        joints_int[4] = max(-70000, joints_int[4])
        piper.JointCtrl(*joints_int)
        time.sleep(0.02)  # 50Hzæ‰§è¡Œé¢‘ç‡
    
    print(f"  âœ“ ç¬›å¡å°”æ—‹è½¬è½¨è¿¹æ‰§è¡Œå®Œæˆ")
```

**æ—‹è½¬çŸ©é˜µè¯´æ˜**ï¼š
```
ç»•Zè½´æ—‹è½¬Î¸è§’çš„æ—‹è½¬çŸ©é˜µ:
Rz(Î¸) = [ cos(Î¸)  -sin(Î¸)   0 ]
        [ sin(Î¸)   cos(Î¸)   0 ]
        [   0        0      1 ]

åº”ç”¨åˆ°æœ«ç«¯å§¿æ€:
new_R = current_R Ã— Rz(Î¸)

ä¿æŒä½ç½®:
new_position = current_position (ä¸å˜)
```

**æ•ˆæœ**ï¼š
- âœ… æ‰€æœ‰å…³èŠ‚ååŒæ—‹è½¬
- âœ… æœ«ç«¯ä½ç½®ä¿æŒä¸å˜
- âœ… æ—‹è½¬è½¨è¿¹å¹³æ»‘
- âœ… æœ‰å›é€€æ–¹æ¡ˆï¼ˆå¦‚æœç¬›å¡å°”è§„åˆ’å¤±è´¥ï¼‰

---

## æŠ€æœ¯ç»†èŠ‚

### åŠ å‡é€Ÿæ›²çº¿

```
é€Ÿåº¦
 â–²
 â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â† åŒ€é€Ÿé˜¶æ®µï¼ˆ80Hz, delay=0.0125sï¼‰
 â”‚    â•±               â•²
 â”‚   â•±                 â•²
 â”‚  â•±                   â•²
 â”‚ â•±                     â•²
 â”‚â•±                       â•²
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ æ—¶é—´
   åŠ é€Ÿ(25%)   å‡é€Ÿ(25%)
```

**åŠ é€Ÿé˜¶æ®µ**ï¼š
```python
delay = 0.02 * (accel_points - idx) / accel_points + 0.0125
# idx=0:  delay = 0.02 + 0.0125 = 0.0325s (æœ€æ…¢)
# idx=5:  delay = 0.0125s (åŒ€é€Ÿ)
```

**å‡é€Ÿé˜¶æ®µ**ï¼š
```python
remaining = total_points - idx
delay = 0.02 * (decel_points - remaining + 1) / decel_points + 0.0125
# é€æ¸å¢åŠ delayï¼Œé™ä½é€Ÿåº¦
```

### ç¬›å¡å°”æ—‹è½¬æ•°å­¦åŸç†

**ç›®æ ‡**ï¼šä¿æŒä½ç½®Pä¸å˜ï¼Œå§¿æ€ä»Ræ—‹è½¬åˆ°R'

```
åˆå§‹ä½å§¿çŸ©é˜µ T:
T = [ R | P ]
    [ 0 | 1 ]

æ—‹è½¬åä½å§¿çŸ©é˜µ T':
T' = [ RÃ—Rz(Î¸) | P ]  â† æ³¨æ„ï¼šä½ç½®Pä¸å˜
     [    0     | 1 ]
```

**å…³é”®**ï¼š
- æ—‹è½¬çŸ©é˜µä½œç”¨åœ¨**æœ«ç«¯åæ ‡ç³»**
- åŸºåæ ‡ç³»çš„ä½ç½®å‘é‡ä¿æŒä¸å˜
- é€šè¿‡IKæ±‚è§£æ¯ä¸ªå§¿æ€å¯¹åº”çš„å…³èŠ‚è§’åº¦

---

## æµ‹è¯•æ–¹æ³•

### æµ‹è¯•1: Pluginæ’å…¥å¹³æ»‘æ€§
```bash
# è®¾ç½®ä¸ºpluginæ¨¡å¼
ACTION_TYPE = 'plugin'
PLUGIN_INSERT_DEPTH = 0.05  # 5cmæ’å…¥æ·±åº¦

# è¿è¡Œå¹¶è§‚å¯Ÿ
python3 button_actions.py
```

**è§‚å¯Ÿè¦ç‚¹**ï¼š
- âœ… æ’å…¥å¼€å§‹ï¼šå¹³æ»‘åŠ é€Ÿï¼Œä¸çŒ›å†²
- âœ… æ’å…¥è¿‡ç¨‹ï¼šæ‰€æœ‰å…³èŠ‚ååŒè¿åŠ¨
- âœ… æ’å…¥ç»“æŸï¼šå¹³æ»‘å‡é€Ÿï¼Œä¸æ€¥åˆ¹

### æµ‹è¯•2: Knobæ—‹è½¬åè°ƒæ€§
```bash
# è®¾ç½®ä¸ºknobæ¨¡å¼
ACTION_TYPE = 'knob'
KNOB_ROTATION_ANGLE = 90  # æ—‹è½¬90åº¦
KNOB_ROTATION_DIRECTION = 'ccw'

# è¿è¡Œå¹¶è§‚å¯Ÿ
python3 button_actions.py
```

**è§‚å¯Ÿè¦ç‚¹**ï¼š
- âœ… æ—‹è½¬æ—¶ï¼šæ‰€æœ‰å…³èŠ‚éƒ½åœ¨è¿åŠ¨ï¼ˆä¸åªæ˜¯joint6ï¼‰
- âœ… ä½ç½®ä¿æŒï¼šXYZåæ ‡åŸºæœ¬ä¸å˜
- âœ… æ—‹è½¬å¹³æ»‘ï¼šæ— æŠ–åŠ¨ã€æ— è·³è·ƒ

### é¢„æœŸç»ˆç«¯è¾“å‡º

**Pluginæ’å…¥**ï¼š
```
æ­¥éª¤3: æ²¿æœ«ç«¯zè½´æ’å…¥ 3.0cm...
  å½“å‰ä½ç½®: (0.326, 0.033, 0.319)
  âœ“ ä½¿ç”¨å§¿æ€é”å®šæ¨¡å¼ï¼ˆç†æƒ³Zè½´æ–¹å‘ï¼‰
  ç§»åŠ¨è·ç¦»: 3.0cm
  æœ«ç«¯Zè½´æ–¹å‘ (åŸºåæ ‡ç³»): ( 1.0000,  0.0000,  0.0000)
  å§¿æ€åå·®è§’åº¦: 8.81Â° (å·²è¡¥å¿)
  âœ“ ä¿æŒç†æƒ³å§¿æ€ä¸å˜
  ç›®æ ‡ä½ç½®: (0.356, 0.033, 0.319)
  [è‡ªå®šä¹‰ç¬›å¡å°”] ç”Ÿæˆæ’å€¼è·¯å¾„...
  âœ“ è‡ªå®šä¹‰ç¬›å¡å°”è§„åˆ’æˆåŠŸ (è¦†ç›–ç‡: 100.0%, è½¨è¿¹ç‚¹: 13)
  [SDK] æ‰§è¡Œç¬›å¡å°”è½¨è¿¹ (13ä¸ªç‚¹)...  # â† æ–°å¢å¹³æ»‘æ‰§è¡Œ
  âœ“ ç¬›å¡å°”è½¨è¿¹æ‰§è¡Œå®Œæˆ
```

**Knobæ—‹è½¬**ï¼š
```
æ­¥éª¤5: æ—‹è½¬ 45Â° (ccw)...
  å½“å‰ä½ç½®: XYZ=(0.356, 0.033, 0.319)
  ä¿æŒä½ç½®ä¸å˜ï¼Œä»…æ—‹è½¬å§¿æ€ 45Â°
  [ç¬›å¡å°”æ—‹è½¬] ç”Ÿæˆæ—‹è½¬è·¯å¾„ (9ä¸ªwaypoints)...  # â† æ–°å¢
  âœ“ ç¬›å¡å°”æ—‹è½¬è§„åˆ’æˆåŠŸ (è¦†ç›–ç‡: 100.0%, è½¨è¿¹ç‚¹: 25)
  [SDK] æ‰§è¡Œæ—‹è½¬è½¨è¿¹ (25ä¸ªç‚¹)...
  âœ“ ç¬›å¡å°”æ—‹è½¬è½¨è¿¹æ‰§è¡Œå®Œæˆ  # â† æ–°å¢
```

---

## å¯¹æ¯”

### ä¿®å¤å‰ vs ä¿®å¤å

| é—®é¢˜ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **æ’å…¥åŠ¨ä½œ** | çŒ›å†²â†’æ€¥åˆ¹ | å¹³æ»‘åŠ é€Ÿâ†’åŒ€é€Ÿâ†’å¹³æ»‘å‡é€Ÿ |
| **å…³èŠ‚åè°ƒ** | ä¸æ˜ç¡® | æ˜ç¡®çš„åŠ å‡é€Ÿæ§åˆ¶ |
| **é€Ÿåº¦é™åˆ¶** | æ— é™åˆ¶ | æœ€å¤§é€Ÿåº¦20 |
| **æ—‹è½¬æ–¹å¼** | åªè½¬joint6 | æ‰€æœ‰å…³èŠ‚ååŒå·¥ä½œ |
| **ä½ç½®ä¿æŒ** | å¯èƒ½åç§» | ä¸¥æ ¼é”å®šXYZ |
| **è¿åŠ¨è´¨é‡** | æœºæ¢°ã€çªå…€ | ä¸æ»‘ã€è‡ªç„¶ |

---

## æ³¨æ„äº‹é¡¹

1. **é€Ÿåº¦å‚æ•°è°ƒæ•´**ï¼š
   - å¦‚æœä»è§‰å¾—å¤ªå¿«ï¼Œé™ä½`smooth_speed`
   - å¦‚æœæ—‹è½¬å¤ªæ…¢ï¼Œå¢å¤§`smooth_rotation_speed`

2. **waypointå¯†åº¦**ï¼š
   - `num_rotation_steps = max(10, int(abs(KNOB_ROTATION_ANGLE) / 5))`
   - æ—‹è½¬è§’åº¦è¶Šå¤§ï¼Œwaypointè¶Šå¤šï¼Œè¶Šå¹³æ»‘

3. **å›é€€æœºåˆ¶**ï¼š
   - å¦‚æœç¬›å¡å°”è§„åˆ’è¦†ç›–ç‡<80%ï¼Œè‡ªåŠ¨å›é€€åˆ°ç®€å•joint6æ—‹è½¬
   - ç¡®ä¿åŠŸèƒ½å¯é æ€§

4. **ç¡¬ä»¶é™åˆ¶**ï¼š
   - joint4é™åˆ¶ï¼š`max(-70000, joints_int[4])`
   - æ£€æŸ¥å…³èŠ‚é™ä½ï¼Œé¿å…è¶…èŒƒå›´

---

## ç›¸å…³æ–‡ä»¶

- `button_actions.py` - ä¸»ä¿®å¤æ–‡ä»¶
  - è¡Œ1520-1548: æ’å…¥åŠ¨ä½œå¹³æ»‘åŒ–
  - è¡Œ2028-2098: Knobæ—‹è½¬ç¬›å¡å°”è·¯å¾„

---

## æ—¥æœŸ
2025-11-24
