# 6D位姿功能状态报告

## ✅ 已完成功能

### 1. 6D位姿输入支持
- **位置**: TARGET_X, TARGET_Y, TARGET_Z (单位：米)
- **姿态**: TARGET_ROLL, TARGET_PITCH, TARGET_YAW (单位：弧度)
- **坐标系**: 基座坐标系
- **Euler角约定**: ZYX旋转顺序（Roll=绕X轴，Pitch=绕Y轴，Yaw=绕Z轴）

### 2. 默认姿态语义修正
- **Roll=Pitch=Yaw=0** 现在正确表示默认姿态（末端朝前）
- 使用公式：`R_final = R_default @ R_relative`
- R_default = `[[0,0,1], [0,1,0], [-1,0,0]]` (末端朝前姿态)
- R_relative = euler_to_rotation_matrix(roll, pitch, yaw)

### 3. RViz可视化
- DisplayTrajectory 发布器已集成
- 启动命令：`./start_button_action.sh --rviz`
- 可实时查看MoveIt轨迹规划结果

### 4. 末端坐标系正确性
- ✅ 末端X轴：旋转矩阵第1列（夹爪张合方向）
- ✅ 末端Y轴：旋转矩阵第2列（横向）
- ✅ 末端Z轴：旋转矩阵第3列（前进方向）← **已修正**

## ⚠️  已知限制

### 1. IK求解精度问题
**现象**：
- 目标位置：(0.20, 0, 0.25)
- IK求解后FK验证：(0.14, 0, 0.25)
- **误差：6cm**

**原因**：
- `piper_arm.py` 中的IK算法为解析解，存在精度限制
- 某些位姿组合在当前姿态下不可达或精度较差

**影响**：
- 主目标位置可以到达（虽然有偏差）
- 按压动作（沿末端z轴移动）可能失败，因为在偏离的位置上继续移动更不可达

**建议解决方案**：
1. **短期**：接受精度限制，调整目标位置到更容易达到的区域（如 X=0.15~0.18, Z=0.25~0.30）
2. **中期**：使用MoveIt的笛卡尔路径规划替代简单IK调用
3. **长期**：优化 `piper_arm.py` 的IK算法，或使用数值IK求解器

### 2. 坐标框架选择
**问题**：当前所有姿态参数都在基座坐标系下描述

**未来改进**（针对视觉检测）：
- 建议实现"按钮法向量模式"
- 输入：按钮的6D位姿（位置 + 法向量）
- 自动计算末端姿态，使得末端z轴对准按钮法向量

## 📋 测试记录

### 测试1：USE_6D_POSE=True, Roll=Pitch=Yaw=0
- **目标**：(0.20, 0, 0.25)
- **结果**：IK求解到达(0.14, 0, 0.25)
- **按压**：失败（目标(0.15, 0, 0.25)不可达）

### 测试2：USE_6D_POSE=False（对照组）
- **目标**：(0.20, 0, 0.25)
- **结果**：IK求解到达(0.14, 0, 0.25)
- **按压**：失败（同样的IK精度问题）

**结论**：IK精度问题与6D位姿功能无关，是piper_arm.py的固有限制。

## 🔧 代码关键修改

### 1. `create_target_transform()` 函数
```python
if use_6d:
    R_default = np.array([[0, 0, 1], [0, 1, 0], [-1, 0, 0]])
    R_relative = euler_to_rotation_matrix(roll, pitch, yaw)
    T[:3, :3] = R_default @ R_relative  # 组合默认姿态和相对旋转
```

### 2. `move_along_end_effector_z()` 函数
```python
# 修正：末端Z轴是第3列，不是第1列
z_axis = current_T[:3, 2]  # 第3列（索引2）
target_T[:3, 3] += z_axis * distance
```

## 📚 使用说明

### 基本配置
```python
# 位置
TARGET_X = 0.18  # 建议范围：0.15~0.20
TARGET_Y = 0.00
TARGET_Z = 0.28  # 建议范围：0.25~0.30

# 姿态（相对于默认朝前姿态）
TARGET_ROLL = 0.0   # 绕末端X轴
TARGET_PITCH = 0.0  # 绕末端Y轴
TARGET_YAW = 0.0    # 绕末端Z轴

USE_6D_POSE = True
```

### 坐标系理解
**末端坐标系**（当Roll=Pitch=Yaw=0时）：
- **Z轴**：指向基坐标+X方向（前进）
- **Y轴**：指向基坐标+Y方向（左侧）
- **X轴**：指向基坐标-Z方向（向下，夹爪张合方向）

**Euler角旋转**：
- Roll > 0：末端向右倾斜（绕末端X轴）
- Pitch > 0：末端向上抬起（绕末端Y轴）
- Yaw > 0：末端逆时针旋转（绕末端Z轴）

## 🎯 推荐工作区域

基于测试经验，推荐的目标位置：
```python
# 可达性良好的区域
TARGET_X = 0.16  # 不要太远
TARGET_Y = 0.00  
TARGET_Z = 0.28  # 稍微提高
```

## 🚀 后续计划

1. **优先级高**：
   - [ ] 实现"按钮法向量模式"，简化视觉检测集成
   - [ ] 使用MoveIt笛卡尔路径规划提高可靠性

2. **优先级中**：
   - [ ] 添加工作空间可达性检查
   - [ ] IK失败时自动调整目标位置

3. **优先级低**：
   - [ ] 优化piper_arm.py的IK算法

## 📞 技术支持

如有问题，请查看：
- `USAGE_6D_POSE.md` - 详细使用文档
- `button_actions.py` - 源代码及注释

---
**最后更新**: 2025年
**状态**: 6D位姿功能已实现，存在已知的IK精度限制
