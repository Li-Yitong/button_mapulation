# 轨迹调试信息说明文档

## 修改概述

已在 `button_actions.py` 中添加详细的轨迹调试信息输出，帮助您调试运动规划和执行过程。

## 新增配置参数

### 1. 调试开关
```python
DEBUG_TRAJECTORY = True  # 是否显示详细的轨迹调试信息
```

- **位置**: 第 96 行
- **作用**: 控制是否显示详细的轨迹调试信息
- **设置为 `True`**: 显示所有详细信息
- **设置为 `False`**: 仅显示简要信息

## 输出信息详解

### 一、规划阶段信息

#### 1. 起始点和目标点
```
📍 起始点 (弧度): [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]
📍 目标点 (弧度): [0.2000, 0.1500, -0.3000, 0.0000, 0.0000, 0.0000]
```
- 显示当前关节角度（起始点）和目标关节角度
- 单位：弧度（rad）

#### 2. 轨迹规划成功信息
```
✓ 规划成功 (轨迹点: 156)
```
- 显示 MoveIt 规划生成的轨迹点总数

#### 3. 轨迹规划详细信息（DEBUG_TRAJECTORY = True 时）
```
======================================================================
📊 轨迹规划详细信息:
======================================================================

点 #0/155:
  时间: 0.000s
  位置 (rad): [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]
  速度 (rad/s): [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]
  加速度 (rad/s²): [0.1234, 0.2345, -0.1567, 0.0000, 0.0000, 0.0000]
  ... (省略 75 个点) ...

点 #78/155:
  时间: 1.500s
  位置 (rad): [0.1000, 0.0750, -0.1500, 0.0000, 0.0000, 0.0000]
  速度 (rad/s): [0.1500, 0.1200, -0.0800, 0.0000, 0.0000, 0.0000]
  加速度 (rad/s²): [0.0234, 0.0345, -0.0567, 0.0000, 0.0000, 0.0000]
  ... (省略 74 个点) ...

点 #155/155:
  时间: 3.000s
  位置 (rad): [0.2000, 0.1500, -0.3000, 0.0000, 0.0000, 0.0000]
  速度 (rad/s): [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]
  加速度 (rad/s²): [-0.1234, -0.2345, 0.1567, 0.0000, 0.0000, 0.0000]

⏱️  总时长: 3.000秒
📈 平均频率: 52.0Hz
======================================================================
```

**说明**:
- **点 #N/M**: 第 N 个点，共 M 个点
- **时间**: 从轨迹起始点到该点的时间（秒）
- **位置 (rad)**: 6 个关节的角度值（弧度）
- **速度 (rad/s)**: 6 个关节的速度值（弧度/秒）
- **加速度 (rad/s²)**: 6 个关节的加速度值（弧度/秒²）
- **总时长**: 整个轨迹执行的预计时间
- **平均频率**: 轨迹点数 / 总时长

### 二、执行阶段信息

#### 1. 采样信息
```
[SDK] 执行轨迹 (采样点: 20, 速度: 50, 频率: 50Hz)
📊 采样索引: [0, 8, 16, 24, 32, 40, 48, 56, 64, 72, 80, 88, 96, 104, 112, 120, 128, 136, 144, 155]
```
- **采样点**: 从规划轨迹中采样的点数（由 `TRAJECTORY_SAMPLE_POINTS` 控制）
- **速度**: SDK 执行速度
- **频率**: SDK 执行频率（由 `SDK_EXECUTE_RATE` 控制）
- **采样索引**: 实际采样的轨迹点索引

#### 2. 执行过程信息（DEBUG_TRAJECTORY = True 时）
```
======================================================================
🚀 开始执行轨迹:
======================================================================
执行点 #0/19 | 已用时: 0.000s | 目标时间: 0.000s
  关节角度 (度): [0.0, 0.0, 0.0, 0.0, 0.0, 0.0]

执行点 #5/19 | 已用时: 0.100s | 目标时间: 0.769s
  关节角度 (度): [5.7, 4.3, -8.6, 0.0, 0.0, 0.0]

执行点 #10/19 | 已用时: 0.200s | 目标时间: 1.538s
  关节角度 (度): [11.5, 8.6, -17.2, 0.0, 0.0, 0.0]

执行点 #15/19 | 已用时: 0.300s | 目标时间: 2.308s
  关节角度 (度): [17.2, 12.9, -25.7, 0.0, 0.0, 0.0]

执行点 #19/19 | 已用时: 0.380s | 目标时间: 3.000s
  关节角度 (度): [11.5, 8.6, -17.2, 0.0, 0.0, 0.0]

✓ 轨迹执行完成，实际用时: 0.380s
======================================================================
```

**说明**:
- **执行点 #N/M**: 当前执行第 N 个采样点，共 M 个采样点
- **已用时**: 从开始执行到现在的实际时间
- **目标时间**: MoveIt 规划的该点应该到达的时间
- **关节角度 (度)**: 6 个关节的目标角度（度）
- **实际用时**: 整个轨迹执行的实际时间

### 三、笛卡尔路径信息

笛卡尔路径规划（如 `move_along_end_effector_z`）也会显示类似的调试信息：

```
[MoveIt笛卡尔] 规划路径（11个路径点）...
✓ 笛卡尔路径规划成功 (覆盖率: 100.0%)

======================================================================
📊 笛卡尔轨迹详细信息:
======================================================================
轨迹总点数: 45
... (显示部分点的详细信息)
⏱️  总时长: 0.600秒
📈 平均频率: 75.0Hz
======================================================================

[SDK] 执行笛卡尔轨迹 (采样点: 20, 速度: 20, 频率: 50Hz)
📊 采样索引: [0, 2, 4, 6, 9, 11, 13, 15, 18, 20, 22, 24, 27, 29, 31, 33, 36, 38, 40, 44]

... (执行过程信息)

✓ 笛卡尔轨迹执行完成，实际用时: 0.420s
```

## 频率配置说明

### 三个关键频率参数（第 89-91 行）

```python
RVIZ_PUBLISH_RATE = 10      # RViz 轨迹发布频率 (Hz)
SDK_EXECUTE_RATE = 50       # SDK 执行轨迹频率 (Hz)
COMMAND_PUBLISH_RATE = 20   # 命令发布频率 (Hz)
```

#### 1. RVIZ_PUBLISH_RATE (10Hz)
- **作用**: 控制向 RViz 发布轨迹可视化消息的频率
- **典型值**: 10Hz（足够流畅显示）
- **影响**: 仅影响 RViz 可视化，不影响实际执行

#### 2. SDK_EXECUTE_RATE (50Hz)
- **作用**: 控制 SDK 执行轨迹采样点的频率
- **典型值**: 50Hz（推荐值）
- **影响**: 
  - 过低（<20Hz）：轨迹不平滑，运动抖动
  - 过高（>100Hz）：可能超出硬件处理能力
  - **这是最重要的频率参数，直接影响机械臂运动质量**

#### 3. COMMAND_PUBLISH_RATE (20Hz)
- **作用**: 控制发布关节命令的频率
- **典型值**: 20-100Hz
- **影响**: 命令发送频率，一般设置为与 SDK_EXECUTE_RATE 相同或稍低

### 采样点数配置（第 92 行）

```python
TRAJECTORY_SAMPLE_POINTS = 20  # 轨迹采样点数
```

- **作用**: 从 MoveIt 规划的轨迹中采样的点数
- **典型值**: 10-50
- **影响**:
  - 过少（<10）：轨迹不平滑，可能偏离规划路径
  - 过多（>50）：执行时间延长，但不一定更平滑
  - **建议**: 短轨迹用 10-20，长轨迹用 20-50

## 时间关系分析

### 预期执行时间 vs 实际执行时间

```
预期执行时间 = MoveIt 规划的总时长（由轨迹最后一点的 time_from_start 决定）
实际执行时间 = 采样点数 / SDK_EXECUTE_RATE + 通信延迟
```

**示例**:
- 规划轨迹: 156 个点，总时长 3.0 秒
- 采样: 20 个点
- SDK 频率: 50Hz
- 理论执行时间: 20 / 50 = 0.4 秒
- 实际执行时间: ~0.38-0.42 秒（含通信延迟）

**注意**: 实际执行时间 **通常远小于** MoveIt 规划时间，因为：
1. 我们只采样部分点（不是全部 156 个点）
2. SDK 执行速度参数可以加速运动
3. 轨迹采样可能跳过一些减速段

## 调试建议

### 1. 轨迹规划问题

如果发现规划的轨迹不合理：
- 检查起始点和目标点是否正确
- 查看轨迹点数是否异常（过多或过少）
- 检查速度和加速度是否合理
- 尝试不同的规划器（修改 `PLANNER_ID`）

### 2. 执行速度问题

如果执行时间与预期不符：
- **太快**: 降低 `SDK_EXECUTE_RATE` 或增加 `TRAJECTORY_SAMPLE_POINTS`
- **太慢**: 提高 `SDK_EXECUTE_RATE` 或减少 `TRAJECTORY_SAMPLE_POINTS`
- **不平滑**: 增加 `TRAJECTORY_SAMPLE_POINTS` 或提高 `SDK_EXECUTE_RATE`

### 3. 位置精度问题

如果末端位置不准确：
- 增加 `TRAJECTORY_SAMPLE_POINTS` 以获取更多中间点
- 检查采样索引是否覆盖关键点
- 验证最后一个采样点是否是轨迹终点

### 4. 性能优化

如果需要更快的执行：
- 减少 `TRAJECTORY_SAMPLE_POINTS`（最低 10）
- 提高 SDK 执行速度参数
- 使用更快的规划器（如 RRTconnect）

## 使用示例

### 1. 启用详细调试
```bash
# 编辑 button_actions.py
DEBUG_TRAJECTORY = True

# 运行测试
./start_button_action.sh --rviz --action push
```

### 2. 关闭详细调试（仅显示关键信息）
```bash
# 编辑 button_actions.py
DEBUG_TRAJECTORY = False

# 运行测试
./start_button_action.sh --rviz --action push
```

### 3. 调整执行频率
```bash
# 编辑 button_actions.py
SDK_EXECUTE_RATE = 30  # 降低到 30Hz，运动更慢但更稳定
TRAJECTORY_SAMPLE_POINTS = 30  # 增加采样点，更平滑

# 运行测试
./start_button_action.sh --rviz --action push
```

## 输出日志解读

### 正常执行示例
```
步骤2: 移动到目标位置...
  [MoveIt] 规划轨迹...
  📍 起始点 (弧度): [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]
  📍 目标点 (弧度): [0.2000, 0.0000, 0.2500, 0.0000, 0.0000, 0.0000]
  ✓ 规划成功 (轨迹点: 156)
  ✓ 轨迹已发布到RViz (频率: 10Hz)
  [SDK] 执行轨迹 (采样点: 20, 速度: 60, 频率: 50Hz)
  ✓ 轨迹执行完成 (用时: 0.380s)
```

### 异常情况示例
```
步骤2: 移动到目标位置...
  [MoveIt] 规划轨迹...
  📍 起始点 (弧度): [0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000]
  📍 目标点 (弧度): [2.5000, 0.0000, 0.5000, 0.0000, 0.0000, 0.0000]
  ❌ 规划失败，切换到SDK模式
```
**分析**: 目标点超出机械臂工作空间，需要调整 TARGET_X/Y/Z 参数

## 总结

通过这些详细的调试信息，您可以：
1. **验证规划**: 检查起始点、目标点、轨迹点数
2. **分析轨迹**: 查看位置、速度、加速度是否合理
3. **监控执行**: 对比实际执行时间和预期时间
4. **优化参数**: 根据实际表现调整频率和采样点数
5. **定位问题**: 快速找到规划或执行阶段的问题

建议先启用 `DEBUG_TRAJECTORY = True` 进行调试，稳定后再关闭以减少日志输出。
